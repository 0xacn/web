<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Login - memorize.ai</title>
	<script defer src='/__/firebase/5.8.3/firebase-app.js'></script>
	<script defer src='/__/firebase/5.8.3/firebase-auth.js'></script>
	<script defer src='/__/firebase/5.8.3/firebase-firestore.js'></script>
	<script defer src='/__/firebase/5.8.3/firebase-messaging.js'></script>
	<script defer src='/__/firebase/5.8.3/firebase-storage.js'></script>
	<script defer src='/__/firebase/init.js'></script>
	<script src="elm/Login.js"></script>
	<script src="js/elm.js"></script>
	<!--script src="js/main.js"></script-->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css" rel="stylesheet">
	<link href="css/main.css" rel="stylesheet">
</head>
<body>
	<script>
	document.addEventListener('DOMContentLoaded', function() {
		const from = new URLSearchParams(window.location.search).get('f') || 'dashboard.html'
		const app = Elm.Page.Login.init({flags: from})
		const updateNameFromCredential = app => displayName => userCredential =>
			userCredential.user.updateProfile({ displayName })
				.then(() => app.ports.userUpdated.send(userCredential.user))
		const sendAppInvalidSignUpMessage = app => error =>
			error && app.ports.invalidSignUp.send(error.message)
		const sendAppInvalidSignInMessage = app => error =>
			error && app.ports.invalidSignIn.send(error.message)
		const redirectToFrom = () =>
			window.location.href = `/${from}`

		firebase.auth().onAuthStateChanged(user =>
			user
				? app.ports.userUpdated.send(user)
				: app.ports.signedOut.send(null)
		)
		app.ports.signUp.subscribe(account =>
			firebase.auth().createUserWithEmailAndPassword(account.email, account.password)
				.then(updateNameFromCredential(app)(account.displayName))
				.then(redirectToFrom)
				.catch(sendAppInvalidSignUpMessage(app))
		)
		app.ports.signIn.subscribe(login =>
			firebase.auth().signInWithEmailAndPassword(login.email, login.password)
				.then(redirectToFrom)
				.catch(sendAppInvalidSignInMessage(app))
		)
		listenSignOut(app)
	})
	</script>
</body>
</html>